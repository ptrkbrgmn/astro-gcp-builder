---
import { createReadStream } from 'fs';
import BaseLayout from '../../layouts/BaseLayout.astro';
import type { GetStaticPathsResult } from 'astro';

import chain from 'stream-chain'; 
import parser from 'stream-json';
import pick from 'stream-json/filters/Pick';
import streamArray from 'stream-json/streamers/StreamArray';

interface Post {
  slug: string;
  title: string;
  author: string;
  content: string;
}

export async function getStaticPaths(): Promise<GetStaticPathsResult> {
  const pages: { params: { slug: string }; props: { post: Post } }[] = [];
  
  const jsonPath = process.env.JSON_FILE_PATH;

  if (!jsonPath) {
    throw new Error("CRITICAL: Environment variable JSON_FILE_PATH was not set. The build cannot proceed.");
  }

  console.log(`Streaming data from: ${jsonPath}`);

  const pipeline = new chain([
    parser(),
    new pick({ filter: '' }),
    new streamArray()
  ] as any);

  createReadStream(jsonPath).pipe(pipeline);

  for await (const { value } of pipeline) {
    const post = value as Post;
    pages.push({
      params: { slug: post.slug },
      props: { post },
    });
  }
  
  console.log(`Finished streaming. Generated ${pages.length} pages.`);
  return pages;
}

interface Props {
  post: Post;
}

const { post } = Astro.props as Props;
---
<BaseLayout title={post.title}>
  <h1>{post.title}</h1>
  <p><em>By {post.author}</em></p>
  <hr>
  <p>{post.content}</p>
</BaseLayout>